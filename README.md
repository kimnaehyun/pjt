# Branch 전략
우리는 GitHub Flow 방식을 기본으로 사용한다.

- master : 제품 배포용 안정 브랜치
- feature/{기능명} : 기능 개발 브랜치
    예) feature/login, feature/post-create
- hotfix/{이슈명} : 배포 중 발생한 긴급 버그 수정 브랜치

# Branch 생성 및 Merge 규칙
1. 모든 작업은 feature 브랜치에서 진행한다.
2. 기능 개발이 완료되면 Pull Request(PR)을 생성한다.
3. 다른 팀원이 코드 리뷰 후 승인하면 master에 merge한다.
4. merge 시 squash merge를 사용하여 commit 내역을 정리한다.

# Commit 메시지 규칙
Commit 메시지는 작업의 목적이 드러나도록 명확하게 작성한다.

형식:
<타입>: <요약 설명>

타입 예시:
feat  : 새로운 기능 추가
fix   : 버그 수정
docs  : 문서 수정
style : 코드 포맷팅, 세미콜론 누락 등 기능 영향 없는 변경
refactor : 코드 개선
test  : 테스트 관련 작업
chore : 빌드 설정, 패키지 관리 등의 잡무 변경

예)
feat: 로그인 페이지 UI 구현
fix: 회원가입 시 이메일 중복 체크 오류 해결
refactor: PostList 컴포넌트 렌더링 코드 개선

# Commit 시점 원칙
- 기능 단위로 commit 한다 (너무 큰 덩어리 X).
- 단, UI + 기능이 완전하지 않아도 구성 요소가 완료되면 중간 commit 허용.

---

# AI 기반 도서 추천 시스템 기술 문서

## 개요
본 시스템은 OpenAI GPT 모델을 활용하여 사용자에게 맞춤형 도서 추천을 제공합니다. 크게 **3가지 AI 추천 방식**을 지원합니다.

---

## 1. 프롬프트 기반 추천 (Prompt-Based Recommendation)

### API 엔드포인트
```
GET /api/recommendations/by-prompt/?prompt={사용자_입력}&nonce={캐시방지}
```

### 알고리즘 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 사용자 입력 수신                                              │
│     예: "제주도 배경의 따뜻한 소설 추천해줘"                        │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. DB에서 도서 목록 조회 (최대 300권)                            │
│     - title, author, category, genre, description 포함          │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. GPT 프롬프트 구성                                            │
│     - 도서 카탈로그 (ID, 제목, 저자, 설명 100자)                   │
│     - 사용자 요청                                                 │
│     - 출력 형식 지정: "book_id|reason" 형태로 반환 요청            │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. OpenAI API 호출                                              │
│     - 모델: gpt-5-mini (설정 가능)                                │
│     - max_output_tokens: 500                                     │
│     - reasoning: minimal, verbosity: low                         │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 응답 파싱                                                     │
│     - "123|제주도 배경의 따뜻한 이야기입니다" 형식 파싱             │
│     - book_id로 DB에서 도서 정보 조회                              │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. 응답 반환                                                     │
│     { book: {도서정보}, reason: "추천 이유" } 배열                │
└─────────────────────────────────────────────────────────────────┘
```

### 핵심 특징
- **추천 이유 제공**: 각 도서에 대해 GPT가 생성한 추천 이유를 함께 반환
- **DB 기반 필터링**: GPT가 선택한 도서 ID가 실제 DB에 존재하는지 검증
- **Fallback 처리**: GPT 응답이 없으면 랜덤 5권 추천

---

## 2. 사용자 프로필 기반 추천 (Profile-Based Recommendation)

### API 엔드포인트
```
GET /api/recommendations/me/?nonce={캐시방지}
```
(인증 필요)

### 알고리즘 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 사용자 프로필 수집                                           │
│     - favorites: 찜한 도서 목록 (최대 10권)                       │
│     - read_books: 읽은 도서 목록 (최대 20권)                      │
│     - occupation: 직업                                           │
│     - gender: 성별                                               │
│     - interests: 관심사                                          │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 제외 목록 생성                                               │
│     - 이미 찜한 도서 + 읽은 도서 ID 집합                          │
│     - 중복 추천 방지                                              │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. GPT 프롬프트 구성                                            │
│     "You are a helpful book recommender. Given a user's         │
│      profile and lists of books they've favorited and read,     │
│      suggest up to 8 book titles..."                            │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. OpenAI API 호출                                              │
│     - max_output_tokens: 360                                     │
│     - 번호가 매겨진 제목 리스트로 응답 요청                        │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. DB 매칭                                                      │
│     - GPT가 추천한 제목으로 DB 검색 (title__icontains)            │
│     - 매칭 실패 시 저자명으로 재검색                               │
│     - 이미 찜/읽은 도서는 제외                                    │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. Fallback 처리                                                │
│     - API 미설정/오류 시: global_recommend_count 상위 8권         │
│     - nonce 있을 시: 시드 기반 랜덤 셔플 (동일 nonce = 동일 결과)  │
└─────────────────────────────────────────────────────────────────┘
```

### 핵심 특징
- **개인화**: 사용자의 독서 이력과 프로필 정보 기반 추천
- **중복 방지**: 이미 찜하거나 읽은 도서는 추천에서 제외
- **재추천 지원**: nonce 파라미터로 "다시 추천" 기능 구현

---

## 3. AI 키워드 검색 (AI-Search)

### API 엔드포인트
```
GET /api/books/ai-search/?prompt={사용자_입력}&nonce={캐시방지}
```

### 알고리즘 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 사용자 자연어 입력 수신                                       │
│     예: "우울할 때 읽기 좋은 힐링 에세이"                          │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 1차 시도: 도서 ID 직접 매칭                                   │
│     - DB 도서 200권 카탈로그 구성                                 │
│     - GPT에게 매칭되는 도서 ID 요청                               │
│     - 성공 시 즉시 반환                                           │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 2차 시도: 키워드 변환                                         │
│     - GPT가 자연어를 검색 키워드로 변환                           │
│     - 최대 10개 키워드/제목 생성                                   │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. DB 검색                                                      │
│     - 키워드로 title, author, genre, category 검색               │
│     - global_recommend_count 순 정렬                             │
│     - 최대 40권 반환                                              │
└─────────────────────┬───────────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. Fallback: 알라딘 API 연동                                     │
│     - DB에 결과가 없으면 알라딘 ItemSearch API 호출               │
│     - 검색된 도서를 DB에 저장 후 반환                              │
└─────────────────────────────────────────────────────────────────┘
```

### 핵심 특징
- **2단계 검색**: ID 직접 매칭 → 키워드 변환 순차 시도
- **외부 API 연동**: DB에 없는 도서는 알라딘에서 검색하여 DB에 추가
- **의미론적 검색**: 사용자의 감정/상황 표현을 키워드로 변환

---

## 기술 스택

| 구성요소 | 기술 |
|---------|------|
| AI 모델 | OpenAI GPT (gpt-5-mini 기본) |
| API 프록시 | SSAFY GMS API Gateway 지원 |
| 백엔드 | Django REST Framework |
| DB | SQLite (개발) / PostgreSQL (프로덕션) |
| 외부 API | 알라딘 도서 API |

---

## 환경 설정

```python
# settings.py
OPENAI_API_KEY = 'your-openai-api-key'  # OpenAI 직접 사용
# 또는
GMS_KEY = 'your-gms-key'  # SSAFY GMS 프록시 사용
OPENAI_MODEL = 'gpt-5-mini'  # 사용할 모델
OPENAI_BASE_URL = None  # 커스텀 엔드포인트 (선택)
```

---

## 성능 최적화

1. **토큰 최소화**: `reasoning: minimal`, `verbosity: low` 설정으로 비용 절감
2. **DB 쿼리 최적화**: `select_related`로 N+1 문제 방지
3. **결과 캐싱**: nonce 기반 시드로 동일 요청 시 일관된 결과 제공
4. **Fallback 체계**: API 오류 시에도 서비스 중단 없이 대체 결과 제공
